<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¶‹åŠ¿åˆ†æ - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</title>
    <!-- å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        success: '#00B42A',
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .modal-backdrop {
                backdrop-filter: blur(2px);
            }
            .filter-select {
                @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all;
            }
            .chart-container {
                @apply h-80 border border-gray-200 rounded-lg p-4 relative mb-8;
            }
            .tab-item {
                @apply px-4 py-2 rounded-md cursor-pointer transition-all;
            }
            .tab-item-active {
                @apply bg-primary text-white;
            }
            .tab-item-inactive {
                @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
            }
            .dropdown-container {
                @apply relative;
            }
            .dropdown-content {
                @apply absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg overflow-hidden max-h-60 overflow-y-auto;
            }
            .multiselect-checkbox {
                @apply mr-2 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded;
            }
            .selected-tags {
                @apply flex flex-wrap gap-2 mt-1;
            }
            .selected-tag {
                @apply bg-primary/10 text-primary text-xs px-2 py-1 rounded-full flex items-center;
            }
            .tag-remove {
                @apply ml-1 cursor-pointer hover:text-primary/80;
            }
            .select-all-item {
                @apply px-4 py-2 border-b border-gray-100 font-medium text-primary cursor-pointer hover:bg-primary/5;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-line-chart text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</h1>
            </div>

            <nav class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">é¦–é¡µ</a>
                <a href="trend-analysis.html" class="text-primary font-medium border-b-2 border-primary px-1 py-5">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
                 <a href="data-distribution.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">æ•°æ®åˆ†å¸ƒ</a>
                <a href="circle-warning.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">æ•°æ®é¢„è­¦</a>
                <a href="admin.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">
                    <i class="fa fa-cog mr-1"></i>æ•°æ®ç®¡ç†
                </a>
            </nav>

            <button class="md:hidden text-gray-600 hover:text-primary" id="mobileMenuBtn">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>

        <div class="md:hidden hidden bg-white border-t border-gray-200" id="mobileMenu">
            <div class="container mx-auto px-4 py-2">
                <a href="index.html" class="block py-3 text-gray-600 hover:text-primary">é¦–é¡µ</a>
                <a href="trend-analysis.html" class="block py-3 text-primary font-medium">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <h2 class="text-xl font-bold mb-6 text-gray-800">æ•°æ®è¶‹åŠ¿åˆ†æ</h2>

        <!-- æ•°æ®çŠ¶æ€æç¤ºåŒº -->
        <div id="dbLoading" class="mb-6 p-3 bg-primary/10 text-primary rounded-lg flex items-center hidden">
            <i class="fa fa-spinner fa-spin mr-2"></i>
            <span>æ­£åœ¨ä»æ•°æ®åº“åŠ è½½æ•°æ®...</span>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                <div id="loadingProgress" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">
                <span id="loadingStatus">å‡†å¤‡åŠ è½½...</span>
            </div>
        </div>

        <div id="noDataAlert" class="bg-warning/10 text-warning p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span>è¯·å…ˆåœ¨é¦–é¡µå¯¼å…¥æ•°æ®ï¼Œç„¶åå†è¿›è¡Œè¶‹åŠ¿åˆ†æ</span>
        </div>

        <div id="dataStructureAlert" class="bg-warning/10 text-warning p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span>æ•°æ®ç»“æ„è¯†åˆ«å¼‚å¸¸</span>
            <div class="mt-2 text-sm">
                <p id="structureMsg">ç³»ç»Ÿæ£€æµ‹åˆ°æ•°æ®æ ¼å¼å¯èƒ½ä¸ç¬¦åˆé¢„æœŸï¼Œå·²å°è¯•è‡ªåŠ¨ä¿®å¤ã€‚</p>
                <div id="structureDetails" class="mt-1 bg-white p-2 rounded text-xs"></div>
            </div>
        </div>

        <div id="dbErrorAlert" class="bg-danger/10 text-danger p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span id="dbErrorMsg">æ•°æ®åº“æ“ä½œå‡ºé”™</span>
            <div id="dbErrorDetails" class="mt-2 text-sm hidden">
                <p>é”™è¯¯è¯¦æƒ…:</p>
                <pre class="bg-white p-2 rounded text-xs"></pre>
            </div>
            <button id="fixDbBtn" class="mt-2 text-sm bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors hidden">
                å°è¯•ä¿®å¤æ•°æ®åº“
            </button>
        </div>

        <div id="debugInfo" class="bg-gray-100 p-4 rounded-lg mb-6 hidden">
            <h3 class="font-medium text-gray-700 mb-2">è°ƒè¯•ä¿¡æ¯</h3>
            <pre id="debugContent" class="text-sm text-gray-600"></pre>
        </div>

        <!-- ç­›é€‰æ¡ä»¶åŒºåŸŸ -->
        <section id="filterSection" class="mb-8 bg-white rounded-lg p-6 card-shadow hidden">
            <h3 class="text-lg font-semibold mb-4">ç­›é€‰æ¡ä»¶</h3>

            <!-- æ—¶é—´èŒƒå›´å’Œå‘¨æœŸè®¾ç½® -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 pb-6 border-b border-gray-100">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç»Ÿè®¡å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" class="filter-select">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç»Ÿè®¡ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" class="filter-select">
                </div>
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm font-medium text-gray-700">ç»Ÿè®¡å‘¨æœŸ</label>
                        <button id="configGroupingBtn" class="text-gray-500 hover:text-primary transition-colors p-1" title="é…ç½®å‘¨æœŸè§„åˆ™">
                            <i class="fa fa-cog"></i>
                        </button>
                    </div>
                    <select id="groupBy" class="filter-select">
                        <option value="day">æŒ‰æ—¥</option>
                        <option value="week">æŒ‰å‘¨</option>
                        <option value="month">æŒ‰æœˆ</option>
                        <option value="quarter">æŒ‰å­£åº¦</option>
                    </select>
                </div>
            </div>

            <!-- å¤šæ¡ä»¶ç­›é€‰åŒºåŸŸï¼ˆæ”¯æŒå¤šé€‰å’Œå…¨é€‰ï¼‰ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- æµ‹ç«™åç§°ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æµ‹ç«™åç§° <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="stationDropdown">
                        <span id="stationDisplay">è¯·é€‰æ‹©æµ‹ç«™</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="stationTags"></div>
                    <div class="dropdown-content hidden" id="stationOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢æµ‹ç«™..." class="w-full p-1 text-sm border border-gray-200 rounded" id="stationSearch">
                        </div>
                        <div class="select-all-item" id="selectAllStations">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="stationValue" value="">
                </div>

                <!-- å®¢æˆ·åç§°ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ·åç§° <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="customerDropdown">
                        <span id="customerDisplay">è¯·é€‰æ‹©å®¢æˆ·</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="customerTags"></div>
                    <div class="dropdown-content hidden" id="customerOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢å®¢æˆ·..." class="w-full p-1 text-sm border border-gray-200 rounded" id="customerSearch">
                        </div>
                        <div class="select-all-item" id="selectAllCustomers">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="customerValue" value="">
                </div>

                <!-- å«æ˜Ÿåç§°ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å«æ˜Ÿåç§° <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="satelliteDropdown">
                        <span id="satelliteDisplay">è¯·å…ˆé€‰æ‹©æµ‹ç«™æˆ–å®¢æˆ·</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="satelliteTags"></div>
                    <div class="dropdown-content hidden" id="satelliteOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢å«æ˜Ÿ..." class="w-full p-1 text-sm border border-gray-200 rounded" id="satelliteSearch">
                        </div>
                        <div class="select-all-item" id="selectAllSatellites">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="satelliteValue" value="">
                </div>

                <!-- ä»»åŠ¡ç»“æœçŠ¶æ€ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç»“æœçŠ¶æ€ <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="statusDropdown">
                        <span id="statusDisplay">è¯·å…ˆé€‰æ‹©å«æ˜Ÿ</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="statusTags"></div>
                    <div class="dropdown-content hidden" id="statusOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢çŠ¶æ€..." class="w-full p-1 text-sm border border-gray-200 rounded" id="statusSearch">
                        </div>
                        <div class="select-all-item" id="selectAllStatuses">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="statusValue" value="">
                </div>

                <!-- ä»»åŠ¡ç±»å‹ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç±»å‹ <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="typeDropdown">
                        <span id="typeDisplay">è¯·å…ˆé€‰æ‹©ä»»åŠ¡çŠ¶æ€</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="typeTags"></div>
                    <div class="dropdown-content hidden" id="typeOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢ç±»å‹..." class="w-full p-1 text-sm border border-gray-200 rounded" id="typeSearch">
                        </div>
                        <div class="select-all-item" id="selectAllTypes">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="typeValue" value="">
                </div>

                <div class="flex items-end">
                    <button id="resetFilters" class="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors mr-2">
                        é‡ç½®ç­›é€‰
                    </button>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input type="checkbox" id="showDataLabels" class="mr-2 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="showDataLabels" class="text-sm text-gray-700">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</label>
                </div>
                <button id="applyFilters" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                    åº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨
                </button>
            </div>
        </section>

        <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
        <section id="chartsSection" class="space-y-8 hidden">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>æµ‹ç«™åç§°è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex gap-2">
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="stationChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="stationChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="stationChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="stationChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>å®¢æˆ·åç§°è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex gap-2">
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="customerChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="customerChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="customerChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="customerChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>å«æ˜Ÿåç§°è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex gap-2">
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="satelliteChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="satelliteChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="satelliteChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="satelliteChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>ä»»åŠ¡ç»“æœçŠ¶æ€è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex gap-2">
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="statusChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="statusChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="statusChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>ä»»åŠ¡ç±»å‹è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex gap-2">
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="typeChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="typeChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="typeChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="typeChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- å‘¨æœŸè§„åˆ™é…ç½®æ¨¡æ€æ¡† -->
    <div id="groupingConfigModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">å‘¨æœŸè§„åˆ™é…ç½®</h3>
                <button id="closeConfigModal" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <div class="mb-6 pb-4 border-b border-gray-100">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar-o text-primary mr-2"></i>æŒ‰æ—¥å‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å‘¨æœŸèµ·å§‹æ—¶é—´</label>
                        <input type="time" id="dayStart" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                    <div>
                        <p class="block text-sm text-gray-600 mb-1">å‘¨æœŸèŒƒå›´</p>
                        <div class="p-2 border border-gray-200 rounded-md bg-gray-50 text-sm">
                            Xæ—¥ <span id="dayStartDisplay">00:00</span> è‡³ X+1æ—¥ <span id="dayEndDisplay">00:00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6 pb-4 border-b border-gray-100">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar-week-o text-primary mr-2"></i>æŒ‰å‘¨å‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å‘¨èµ·å§‹æ—¥</label>
                        <select id="weekStartDay" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                            <option value="0">å‘¨æ—¥</option>
                            <option value="1" selected>å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                            <option value="6">å‘¨å…­</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">èµ·å§‹æ—¶é—´</label>
                        <input type="time" id="weekStartTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                </div>
            </div>

            <div class="mb-6 pb-4 border-b border-gray-100">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar text-primary mr-2"></i>æŒ‰æœˆå‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">æœˆèµ·å§‹æ—¥æœŸ</label>
                        <input type="number" id="monthStartDate" min="1" max="31" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">èµ·å§‹æ—¶é—´</label>
                        <input type="time" id="monthStartTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar-check-o text-primary mr-2"></i>æŒ‰å­£åº¦å‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å­£åº¦èµ·å§‹æœˆä»½</label>
                        <select id="quarterStartMonth" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                            <option value="1">1æœˆï¼ˆQ1:1-3æœˆï¼‰</option>
                            <option value="4">4æœˆï¼ˆQ2:4-6æœˆï¼‰</option>
                            <option value="7">7æœˆï¼ˆQ3:7-9æœˆï¼‰</option>
                            <option value="10">10æœˆï¼ˆQ4:10-12æœˆï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">èµ·å§‹æ—¶é—´</label>
                        <input type="time" id="quarterStartTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                </div>
            </div>

            <button id="saveGroupingConfig" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                ä¿å­˜é…ç½®
            </button>
        </div>
    </div>

    <script>
        // å­—æ®µæ˜ å°„é…ç½®
        const FIELD_MAPPING = {
            'å®¢æˆ·åç§°': 'customer',
            'å«æ˜Ÿåç§°': 'satellite_name',
            'æµ‹ç«™åç§°': 'station_name',
            'ä»»åŠ¡ç»“æœçŠ¶æ€': 'task_result',
            'ä»»åŠ¡ç±»å‹': 'task_type',
            'å¼€å§‹æ—¶é—´': 'start_time',
            'è®¡åˆ’ID': 'id'
        };

        // ==================== IndexedDBç¼“å­˜ç®¡ç†å™¨ï¼ˆä»index.htmlå¤åˆ¶ï¼‰ ====================
        
        // IndexedDBç¼“å­˜ç®¡ç†å™¨
        class CacheManager {
            constructor() {
                this.dbName = 'SatelliteDataCache';
                this.dbVersion = 3;
                this.allDataStoreName = 'allDataCache';
                this.metaStoreName = 'metaData';
                this.db = null;
                // ç§»é™¤ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå§‹ç»ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜
                this.cacheExpiry = Infinity; 
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => {
                        console.error('âŒ IndexedDBåˆå§‹åŒ–å¤±è´¥:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('âœ… IndexedDBåˆå§‹åŒ–æˆåŠŸ');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        console.log('ğŸ”§ å‡çº§IndexedDBç»“æ„...');

                        // å…¨æ•°æ®å­˜å‚¨ç©ºé—´
                        if (!this.db.objectStoreNames.contains(this.allDataStoreName)) {
                            const allDataStore = this.db.createObjectStore(this.allDataStoreName, { keyPath: 'id' });
                            allDataStore.createIndex('timestamp', 'timestamp', { unique: false });
                            allDataStore.createIndex('start_time', 'start_time', { unique: false });
                            console.log('ğŸ“¦ åˆ›å»ºå…¨æ•°æ®å­˜å‚¨ç©ºé—´');
                        }

                        // å…ƒæ•°æ®å­˜å‚¨ç©ºé—´
                        if (!this.db.objectStoreNames.contains(this.metaStoreName)) {
                            const metaStore = this.db.createObjectStore(this.metaStoreName, { keyPath: 'key' });
                            console.log('ğŸ“¦ åˆ›å»ºå…ƒæ•°æ®å­˜å‚¨ç©ºé—´');
                        }
                    };
                });
            }

            // ä»æœ¬åœ°ç¼“å­˜æŸ¥è¯¢æ•°æ®ï¼ˆæ”¯æŒæ—¶é—´èŒƒå›´ç­›é€‰ï¼‰
            async queryAllData(filters = {}) {
                if (!this.db) await this.init();
                
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.allDataStoreName], 'readonly');
                    const store = transaction.objectStore(this.allDataStoreName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        let results = request.result || [];
                        
                        // åº”ç”¨æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼ˆé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜ï¼‰
                        if (filters.startDate || filters.endDate) {
                            let startTime, endTime;
                            
                            if (filters.startDate) {
                                // è§£æå¼€å§‹æ—¥æœŸä¸ºæœ¬åœ°æ—¶é—´00:00:00
                                startTime = this.parseLocalDateToTimestamp(filters.startDate, 0, 0, 0);
                                console.log(`ğŸ” ç­›é€‰å¼€å§‹æ—¶é—´: ${filters.startDate} -> ${new Date(startTime).toLocaleString()}`);
                            }
                            
                            if (filters.endDate) {
                                // è§£æç»“æŸæ—¥æœŸä¸ºæœ¬åœ°æ—¶é—´23:59:59.999
                                endTime = this.parseLocalDateToTimestamp(filters.endDate, 23, 59, 59, 999);
                                console.log(`ğŸ” ç­›é€‰ç»“æŸæ—¶é—´: ${filters.endDate} -> ${new Date(endTime).toLocaleString()}`);
                            }
                            
                            const beforeFilter = results.length;
                            results = results.filter(record => {
                                const recordTime = record.timestamp || this.parseTimeToTimestamp(record.start_time);
                                
                                if (filters.startDate && recordTime < startTime) return false;
                                if (filters.endDate && recordTime > endTime) return false;
                                
                                return true;
                            });
                            
                            console.log(`ğŸ” æ—¶é—´ç­›é€‰: ${beforeFilter} -> ${results.length} æ¡æ•°æ®`);
                        }
                        
                        console.log(`ğŸ” ä»æœ¬åœ°ç¼“å­˜æŸ¥è¯¢åˆ° ${results.length} æ¡æ•°æ®`);
                        resolve(results);
                    };

                    request.onerror = () => {
                        console.error('âŒ æŸ¥è¯¢æœ¬åœ°ç¼“å­˜å¤±è´¥:', request.error);
                        resolve([]);
                    };
                });
            }

            // è§£æå„ç§æ—¶é—´æ ¼å¼ä¸ºæ—¶é—´æˆ³ï¼ˆé¿å…æ—¶åŒºè½¬æ¢ï¼‰
            parseTimeToTimestamp(timeValue) {
                if (typeof timeValue === 'number') {
                    return timeValue > 1000000000000 ? timeValue : timeValue * 1000;
                }
                
                if (typeof timeValue === 'string') {
                    const cleanTimeStr = timeValue.replace(/[TZ]/g, ' ').replace(/[+-]\d{2}:\d{2}$/, '').trim();
                    // ä½¿ç”¨æœ¬åœ°æ—¶åŒºè§£ææ—¶é—´ï¼Œé¿å…UTCè½¬æ¢
                    const date = this.parseLocalTime(cleanTimeStr);
                    return isNaN(date.getTime()) ? 0 : date.getTime();
                }
                
                if (timeValue instanceof Date) {
                    return timeValue.getTime();
                }
                
                return 0;
            }

            // è§£ææœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²ä¸ºæ—¶é—´æˆ³ï¼ˆé¿å…æ—¶åŒºè½¬æ¢ï¼‰
            parseLocalDateToTimestamp(dateStr, hours = 0, minutes = 0, seconds = 0, ms = 0) {
                if (!dateStr) return 0;
                
                try {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JavaScriptæœˆä»½ä»0å¼€å§‹
                        const day = parseInt(parts[2]);
                        
                        // ç›´æ¥æ„é€ æœ¬åœ°æ—¶é—´ï¼Œé¿å…UTCè½¬æ¢
                        const date = new Date(year, month, day, hours, minutes, seconds, ms);
                        return date.getTime();
                    }
                } catch (error) {
                    console.warn('è§£ææ—¥æœŸå¤±è´¥:', dateStr, error);
                }
                
                return 0;
            }

            // è§£ææœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼Œé¿å…UTCè½¬æ¢
            parseLocalTime(timeStr) {
                if (!timeStr) return new Date(NaN);
                
                try {
                    // å°è¯•è§£æ YYYY-MM-DD HH:mm:ss æ ¼å¼
                    const match = timeStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);
                    if (match) {
                        const [, year, month, day, hour = 0, minute = 0, second = 0] = match;
                        // ç›´æ¥æ„é€ æœ¬åœ°æ—¶é—´ï¼Œä¸ç»è¿‡UTCè½¬æ¢
                        return new Date(
                            parseInt(year), 
                            parseInt(month) - 1, 
                            parseInt(day), 
                            parseInt(hour), 
                            parseInt(minute), 
                            parseInt(second)
                        );
                    }
                    
                    // å›é€€åˆ°é»˜è®¤è§£æ
                    return new Date(timeStr);
                } catch (error) {
                    return new Date(NaN);
                }
            }

            // æ£€æŸ¥å…¨æ•°æ®ç¼“å­˜æ˜¯å¦å­˜åœ¨
            async checkAllDataCache() {
                if (!this.db) await this.init();
                
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.metaStoreName], 'readonly');
                    const store = transaction.objectStore(this.metaStoreName);
                    const request = store.get('allDataMeta');

                    request.onsuccess = () => {
                        const meta = request.result;
                        
                        if (!meta) {
                            console.log('ğŸ” æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨');
                            resolve(null);
                            return;
                        }
                        
                        console.log(`âœ… æœ¬åœ°ç¼“å­˜å­˜åœ¨ï¼ŒåŒ…å« ${meta.totalCount} æ¡è®°å½•ï¼Œæœ€åæ›´æ–°ï¼š${new Date(meta.lastUpdated).toLocaleString()}`);
                        resolve(meta);
                    };

                    request.onerror = () => {
                        console.error('âŒ æ£€æŸ¥æœ¬åœ°ç¼“å­˜å¤±è´¥:', request.error);
                        resolve(null);
                    };
                });
            }
        }

        // åˆ›å»ºå…¨å±€ç¼“å­˜ç®¡ç†å™¨å®ä¾‹
        const cacheManager = new CacheManager();

        // å‘¨æœŸè§„åˆ™å¼•æ“ï¼ˆä¿ç•™ç°æœ‰é€»è¾‘ï¼‰
        class CycleRuleEngine {
            constructor() {
                this.config = {
                    day: { start: '00:00' },
                    week: { startDay: 1, startTime: '00:00' },
                    month: { startDate: 1, startTime: '00:00' },
                    quarter: { startMonth: 1, startTime: '00:00' }
                };
                this.loadConfig();
            }

            loadConfig() {
                const savedConfig = localStorage.getItem('cycleRules');
                if (savedConfig) this.config = JSON.parse(savedConfig);
            }

            saveConfig() {
                localStorage.setItem('cycleRules', JSON.stringify(this.config));
            }

            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.saveConfig();
            }

            groupByStartTime(data, groupBy, planIdField, startTimeField) {
                const sortedData = [...data].sort((a, b) => {
                    // a[startTimeField] å¯èƒ½æ˜¯ Date æˆ– å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸º Date å¯¹è±¡æ¯”è¾ƒ
                    const dateA = a[startTimeField] instanceof Date ? a[startTimeField] : new Date(a[startTimeField]);
                    const dateB = b[startTimeField] instanceof Date ? b[startTimeField] : new Date(b[startTimeField]);
                    return dateA - dateB;
                });

                const groups = {};
                const groupMetadata = {};

                // å…ˆæŒ‰è®¡åˆ’IDå»é‡ï¼Œä¿ç•™æœ€æ–°çš„è®°å½•
                const uniqueDataMap = new Map();
                sortedData.forEach(item => {
                    const planId = item[planIdField];
                    if (planId) {
                        uniqueDataMap.set(planId, item);
                    }
                });
                
                const uniqueData = Array.from(uniqueDataMap.values());
                
                uniqueData.forEach(item => {
                    const startTime = item[startTimeField];
                    if (!startTime) return;

                    const itemDate = startTime instanceof Date ? startTime : new Date(startTime);
                    let group;

                    switch (groupBy) {
                        case 'day': group = this.getDayGroup(itemDate); break;
                        case 'week': group = this.getWeekGroup(itemDate); break;
                        case 'month': group = this.getMonthGroup(itemDate); break;
                        case 'quarter': group = this.getQuarterGroup(itemDate); break;
                        default: return;
                    }

                    if (!groups[group.key]) {
                        groups[group.key] = [];
                        groupMetadata[group.key] = group;
                    }
                    groups[group.key].push(item);
                });

                const sortedKeys = Object.keys(groups).sort((a, b) =>
                    groupMetadata[a].rangeStart - groupMetadata[b].rangeStart
                );

                return { groups, groupMetadata, sortedKeys };
            }

            getDayGroup(date) {
                const { hours, minutes } = this.parseTimeToHoursMinutes(this.config.day.start);
                const originalDate = new Date(date);

                // åˆ›å»ºå‚è€ƒæ—¥æœŸï¼ˆåªä¿ç•™å¹´æœˆæ—¥ï¼‰
                const referenceDate = new Date(originalDate.getFullYear(), originalDate.getMonth(), originalDate.getDate());
                // è®¾ç½®å‚è€ƒèµ·å§‹æ—¶é—´
                referenceDate.setHours(hours, minutes, 0, 0);

                // ä¿®å¤0ç‚¹å‘¨æœŸè®¡ç®—é—®é¢˜ï¼š
                let cycleStart;
                if (hours === 0 && minutes === 0) {
                    cycleStart = new Date(originalDate.getFullYear(), originalDate.getMonth(), originalDate.getDate(), 0, 0, 0, 0);
                } else {
                    cycleStart = originalDate >= referenceDate
                        ? referenceDate
                        : new Date(referenceDate.getTime() - 24 * 60 * 60 * 1000);
                }

                const cycleEnd = new Date(cycleStart.getTime() + 24 * 60 * 60 * 1000);

                const groupKey = `${cycleStart.getFullYear()}-${String(cycleStart.getMonth() + 1).padStart(2, '0')}-${String(cycleStart.getDate()).padStart(2, '0')}`;

                if (hours === 0 && minutes === 0) {
                    const testDate = new Date(originalDate);
                    testDate.setHours(0, 0, 0, 0);
                    if (originalDate >= testDate && originalDate < new Date(testDate.getTime() + 24 * 60 * 60 * 1000)) {
                        const correctKey = `${testDate.getFullYear()}-${String(testDate.getMonth() + 1).padStart(2, '0')}-${String(testDate.getDate()).padStart(2, '0')}`;
                        if (correctKey !== groupKey) {
                            return {
                                key: correctKey,
                                label: correctKey,
                                rangeStart: testDate,
                                rangeEnd: new Date(testDate.getTime() + 24 * 60 * 60 * 1000)
                            };
                        }
                    }
                }

                return { key: groupKey, label: groupKey, rangeStart: cycleStart, rangeEnd: cycleEnd };
            }

            getWeekGroup(date) {
                const { startDay, startTime } = this.config.week;
                const { hours, minutes } = this.parseTimeToHoursMinutes(startTime);

                const originalDate = new Date(date);
                const referenceDate = new Date(originalDate);
                referenceDate.setHours(hours, minutes, 0, 0);

                let dayDiff = referenceDate.getDay() - startDay;
                if (dayDiff < 0) dayDiff += 7;

                const cycleStart = new Date(referenceDate);
                cycleStart.setDate(referenceDate.getDate() - dayDiff);

                if (originalDate < cycleStart) {
                    cycleStart.setDate(cycleStart.getDate() - 7);
                }

                const cycleEnd = new Date(cycleStart);
                cycleEnd.setDate(cycleEnd.getDate() + 7);

                const weekNumber = this.getWeekNumber(cycleStart);
                const groupKey = `${cycleStart.getFullYear()}-W${weekNumber}`;

                return { key: groupKey, label: groupKey, rangeStart: cycleStart, rangeEnd: cycleEnd };
            }

            getMonthGroup(date) {
                const { startDate, startTime } = this.config.month;
                const { hours, minutes } = this.parseTimeToHoursMinutes(startTime);

                const originalDate = new Date(date);
                const year = originalDate.getFullYear();
                const month = originalDate.getMonth();

                const referenceDate = new Date(year, month, startDate, hours, minutes, 0, 0);

                let cycleStart;
                if (originalDate >= referenceDate) {
                    cycleStart = new Date(referenceDate);
                } else {
                    cycleStart = new Date(month === 0 ? year - 1 : year, month === 0 ? 11 : month - 1, startDate, hours, minutes, 0, 0);
                }

                const cycleEnd = new Date(cycleStart.getFullYear(), cycleStart.getMonth() + 1, startDate, hours, minutes, 0, 0);

                const groupKey = `${cycleStart.getFullYear()}-${String(cycleStart.getMonth() + 1).padStart(2, '0')}`;

                return { key: groupKey, label: groupKey, rangeStart: cycleStart, rangeEnd: cycleEnd };
            }

            getQuarterGroup(date) {
                const { startMonth, startTime } = this.config.quarter;
                const { hours, minutes } = this.parseTimeToHoursMinutes(startTime);

                const originalDate = new Date(date);
                const year = originalDate.getFullYear();
                const month = originalDate.getMonth() + 1; // 1-12

                const relative = (month - startMonth + 12) % 12;
                const quarterIndex = Math.floor(relative / 3); // 0..3 within the cycle
                const quarterStartMonth = ((startMonth + quarterIndex * 3 - 1) % 12) + 1; // 1-12

                const quarterStartYear = (quarterStartMonth > month) ? year - 1 : year;

                const cycleStart = new Date(quarterStartYear, quarterStartMonth - 1, 1, hours, minutes, 0, 0);
                const cycleEnd = new Date(cycleStart.getFullYear(), cycleStart.getMonth() + 3, 1, hours, minutes, 0, 0);

                const quarterNumber = Math.floor((quarterStartMonth - 1) / 3) + 1;
                const groupKey = `${cycleStart.getFullYear()}-Q${quarterNumber}`;

                return { key: groupKey, label: groupKey, rangeStart: cycleStart, rangeEnd: cycleEnd };
            }

            parseTimeToHoursMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return { hours: hours || 0, minutes: minutes || 0 };
            }

            getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ—¥æœŸï¼ˆç®€åŒ–é€»è¾‘ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (startDateInput) startDateInput.value = formatDate(sevenDaysAgo);
            if (endDateInput) endDateInput.value = formatDate(today);
        });

        // å›¾è¡¨ç”Ÿæˆå™¨ï¼ˆæ›²çº¿å›¾ï¼‰- ä¼˜åŒ–å¤§æ•°æ®é›†å¤„ç†
        class ChartGenerator {
            constructor() {
                this.charts = {};
                this.colors = [
                    '#165DFF', '#36CFC9', '#722ED1', '#FF7D00', '#F53F3F',
                    '#00B42A', '#86909C', '#F7BA1E', '#E53E3E', '#48BB78',
                    '#3182CE', '#805AD5', '#ED8936', '#ECC94B', '#6B46C1'
                ];
                this.lineStyles = ['solid', 'dashed', 'dotted'];
                this.maxDataPoints = 1000; // å•ä¸ªå›¾è¡¨æœ€å¤§æ•°æ®ç‚¹æ•°
                this.maxSeries = 20; // æœ€å¤§ç³»åˆ—æ•°
            }

            destroyChart(chartId) {
                if (this.charts[chartId]) {
                    try {
                        this.charts[chartId].destroy();
                    } catch (error) {
                        console.warn('é”€æ¯å›¾è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    }
                    delete this.charts[chartId];
                }
                
                // æ¸…ç†ä¼˜åŒ–æç¤º
                this.removeOptimizationNotice(chartId);
            }
            
            showOptimizationNotice(chartId, info) {
                const chartContainer = document.getElementById(chartId)?.closest('.chart-container');
                if (!chartContainer) return;
                
                // ç§»é™¤æ—§çš„æç¤º
                this.removeOptimizationNotice(chartId);
                
                const notice = document.createElement('div');
                notice.id = `${chartId}-optimization-notice`;
                notice.className = 'absolute top-2 right-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded shadow-sm z-10';
                
                let message = 'å·²ä¼˜åŒ–æ˜¾ç¤º: ';
                if (info.originalDataPoints > info.optimizedDataPoints) {
                    message += `æ•°æ®ç‚¹ ${info.originalDataPoints}â†’${info.optimizedDataPoints}`;
                }
                if (info.originalSeries > info.optimizedSeries) {
                    if (message.length > 10) message += ', ';
                    message += `ç³»åˆ— ${info.originalSeries}â†’${info.optimizedSeries}`;
                }
                
                notice.innerHTML = `
                    <i class="fa fa-info-circle mr-1"></i>${message}
                    <button onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                chartContainer.appendChild(notice);
                
                // 10ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (notice.parentElement) {
                        notice.remove();
                    }
                }, 10000);
            }
            
            removeOptimizationNotice(chartId) {
                const notice = document.getElementById(`${chartId}-optimization-notice`);
                if (notice) {
                    notice.remove();
                }
            }

            generateTrendChart(chartId, title, xLabels, datasets) {
                this.destroyChart(chartId);
                const ctx = document.getElementById(chartId).getContext('2d');
                const emptyState = document.getElementById(`${chartId}Empty`);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ•°æ®æ ‡ç­¾
                const showLabels = document.getElementById('showDataLabels')?.checked || false;

                const hasData = datasets.some(dataset => dataset.data.some(v => v > 0));
                if (!hasData) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    return null;
                }

                if (emptyState) emptyState.classList.add('hidden');

                // å¤§æ•°æ®é›†ä¼˜åŒ–ï¼šé™åˆ¶æ•°æ®ç‚¹å’Œç³»åˆ—æ•°
                let optimizedLabels = xLabels;
                let optimizedDatasets = datasets;

                // å¦‚æœæ•°æ®ç‚¹è¿‡å¤šï¼Œè¿›è¡Œé‡‡æ ·
                if (xLabels.length > this.maxDataPoints) {
                    console.warn(`æ•°æ®ç‚¹è¿‡å¤š(${xLabels.length})ï¼Œè‡ªåŠ¨é‡‡æ ·è‡³${this.maxDataPoints}ä¸ªç‚¹`);
                    const step = Math.ceil(xLabels.length / this.maxDataPoints);
                    optimizedLabels = xLabels.filter((_, i) => i % step === 0);
                    optimizedDatasets = datasets.map(dataset => ({
                        ...dataset,
                        data: dataset.data.filter((_, i) => i % step === 0)
                    }));
                }

                // å¦‚æœç³»åˆ—è¿‡å¤šï¼Œåªæ˜¾ç¤ºå‰Nä¸ªæœ€é‡è¦çš„ç³»åˆ—
                if (datasets.length > this.maxSeries) {
                    console.warn(`ç³»åˆ—è¿‡å¤š(${datasets.length})ï¼Œåªæ˜¾ç¤ºå‰${this.maxSeries}ä¸ªç³»åˆ—`);
                    // æŒ‰æ•°æ®æ€»å’Œæ’åºï¼Œé€‰æ‹©æœ€é‡è¦çš„ç³»åˆ—
                    const sortedDatasets = optimizedDatasets
                        .map((dataset, index) => ({
                            ...dataset,
                            originalIndex: index,
                            totalValue: dataset.data.reduce((sum, val) => sum + (val || 0), 0)
                        }))
                        .sort((a, b) => b.totalValue - a.totalValue)
                        .slice(0, this.maxSeries);
                    optimizedDatasets = sortedDatasets;
                }

                // æ ¹æ®æ•°æ®é‡è°ƒæ•´æ€§èƒ½è®¾ç½®
                const totalDataPoints = optimizedLabels.length * optimizedDatasets.length;
                const isLargeDataset = totalDataPoints > 10000;

                // æ›²çº¿å›¾æ ·å¼é…ç½® - å¤§æ•°æ®é›†æ—¶ç®€åŒ–æ ·å¼
                const styledDatasets = optimizedDatasets.map((dataset, i) => ({
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: this.colors[i % this.colors.length],
                    backgroundColor: isLargeDataset ? 'transparent' : `${this.colors[i % this.colors.length]}20`,
                    borderWidth: isLargeDataset ? 1 : 2,
                    borderDash: isLargeDataset ? [] : (
                        this.lineStyles[i % this.lineStyles.length] === 'dashed' ? [5, 5] :
                        this.lineStyles[i % this.lineStyles.length] === 'dotted' ? [2, 2] : []
                    ),
                    tension: isLargeDataset ? 0 : 0.3,
                    fill: false,
                    pointBackgroundColor: this.colors[i % this.colors.length],
                    pointRadius: isLargeDataset ? 0 : 4, // å¤§æ•°æ®é›†æ—¶éšè—æ•°æ®ç‚¹
                    pointHoverRadius: isLargeDataset ? 3 : 6,
                    pointHitRadius: isLargeDataset ? 5 : 8,
                    datalabels: {
                        display: showLabels && !isLargeDataset, // å¤§æ•°æ®é›†æ—¶ä¸æ˜¾ç¤ºæ•°æ®æ ‡ç­¾
                        color: this.colors[i % this.colors.length],
                        anchor: 'end',
                        align: 'top',
                        font: {
                            size: 10,
                            weight: 'bold'
                        },
                        formatter: function(value) {
                            return value > 0 ? value : '';
                        }
                    }
                }));

                // æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶
                Chart.register(ChartDataLabels);

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: optimizedLabels,
                        datasets: styledDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: isLargeDataset ? 'nearest' : 'index',
                            intersect: false,
                        },
                        plugins: {
                            datalabels: {
                                display: showLabels && !isLargeDataset
                            },
                            title: {
                                display: true,
                                text: title + (isLargeDataset ? ' (å·²ä¼˜åŒ–æ˜¾ç¤º)' : ''),
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    maxWidth: isLargeDataset ? 100 : 200
                                }
                            },
                            tooltip: {
                                mode: isLargeDataset ? 'nearest' : 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw} æ¬¡`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: !isLargeDataset },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    maxTicksLimit: isLargeDataset ? 20 : undefined
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { display: !isLargeDataset },
                                ticks: {
                                    precision: 0,
                                    stepSize: 1,
                                    maxTicksLimit: isLargeDataset ? 10 : undefined
                                }
                            }
                        },
                        animation: {
                            duration: isLargeDataset ? 300 : 1000, // å¤§æ•°æ®é›†æ—¶å‡å°‘åŠ¨ç”»æ—¶é—´
                            easing: 'easeOutQuart'
                        },
                        elements: {
                            point: {
                                hoverRadius: isLargeDataset ? 3 : 6
                            }
                        },
                        // æ€§èƒ½ä¼˜åŒ–é€‰é¡¹
                        parsing: isLargeDataset ? false : true,
                        normalized: isLargeDataset ? true : false
                    }
                });

                this.charts[chartId] = chart;
                
                // æ˜¾ç¤ºä¼˜åŒ–æç¤º
                if (isLargeDataset || xLabels.length > this.maxDataPoints || datasets.length > this.maxSeries) {
                    this.showOptimizationNotice(chartId, {
                        originalDataPoints: xLabels.length,
                        optimizedDataPoints: optimizedLabels.length,
                        originalSeries: datasets.length,
                        optimizedSeries: optimizedDatasets.length
                    });
                }
                
                return chart;
            }
        }

        // æ”¯æŒå…¨é€‰çš„å¤šé€‰ä¸‹æ‹‰ç»„ä»¶ï¼ˆä¸å˜ï¼‰
        class MultiSelectDropdown {
            constructor(dropdownId, optionsId, displayId, valueId, tagsId, searchId, selectAllId, onChange) {
                this.dropdownId = dropdownId;
                this.optionsId = optionsId;
                this.displayId = displayId;
                this.valueId = valueId;
                this.tagsId = tagsId;
                this.searchId = searchId;
                this.selectAllId = selectAllId;
                this.onChange = onChange;

                this.selectedValues = [];
                this.allOptions = [];
                this.isAllSelected = false;

                this.init();
            }

            init() {
                const dropdownEl = document.getElementById(this.dropdownId);
                if (dropdownEl) {
                    dropdownEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                }

                const searchEl = document.getElementById(this.searchId);
                if (searchEl) {
                    searchEl.addEventListener('input', (e) => {
                        this.filterOptions(e.target.value);
                    });
                }

                const selectAllCheckbox = document.getElementById(this.selectAllId);
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleSelectAll();
                    });
                }

                document.addEventListener('click', (e) => {
                    const optionsContainer = document.getElementById(this.optionsId);
                    const isClickInside = optionsContainer && (optionsContainer.contains(e.target) ||
                                          (dropdownEl && dropdownEl.contains(e.target)));

                    if (!isClickInside) {
                        this.closeDropdown();
                    }
                });
            }

            setOptions(options) {
                this.allOptions = [...options];
                this.renderOptions();
            }

            renderOptions(filter = '') {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;

                while (optionsContainer.children.length > 2) {
                    optionsContainer.removeChild(optionsContainer.lastChild);
                }

                const filteredOptions = this.allOptions.filter(option =>
                    option.label.toLowerCase().includes(filter.toLowerCase())
                );

                filteredOptions.forEach(option => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'tab-item tab-item-inactive flex items-center p-2';
                    optionEl.innerHTML = `
                        <input type="checkbox" class="multiselect-checkbox"
                               data-value="${option.value}"
                               ${this.selectedValues.includes(option.value) ? 'checked' : ''}>
                        <span>${option.label}</span>
                    `;

                    optionEl.querySelector('input').addEventListener('change', (e) => {
                        e.stopPropagation();
                        this.toggleSelection(option.value, e.target.checked);
                    });

                    optionEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = optionEl.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                            const ev = new Event('change', { bubbles: false });
                            checkbox.dispatchEvent(ev);
                        }
                    });

                    optionsContainer.appendChild(optionEl);
                });

                this.updateSelectAllStatus();
            }

            filterOptions(keyword) {
                this.renderOptions(keyword);
            }

            toggleSelection(value, isChecked) {
                if (isChecked && !this.selectedValues.includes(value)) {
                    this.selectedValues.push(value);
                } else if (!isChecked && this.selectedValues.includes(value)) {
                    this.selectedValues = this.selectedValues.filter(v => v !== value);
                }

                this.updateDisplay();
                this.updateTags();
                this.updateSelectAllStatus();

                if (this.onChange) {
                    this.onChange([...this.selectedValues]);
                }

                this.openDropdown();
            }

            toggleSelectAll() {
                const selectAllEl = document.getElementById(this.selectAllId);
                if (!selectAllEl) return;
                let checkbox = selectAllEl.querySelector('input[type="checkbox"]');

                if (!checkbox) {
                    this.updateSelectAllStatus();
                    checkbox = selectAllEl.querySelector('input[type="checkbox"]');
                    if (!checkbox) return;
                }

                checkbox.checked = !checkbox.checked;
                const event = new Event('change', { bubbles: false });
                checkbox.dispatchEvent(event);
            }

            updateSelectAllStatus() {
                const optionsContainer = document.getElementById(this.optionsId);
                const selectAllEl = document.getElementById(this.selectAllId);
                if (!optionsContainer || !selectAllEl) return;

                const checkboxes = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]'))
                    .filter(cb => !cb.closest('#' + this.selectAllId));

                const visibleOptionsCount = checkboxes.length;
                const selectedCount = checkboxes.filter(cb => cb.checked).length;

                let checkbox = selectAllEl.querySelector('input[type="checkbox"]');

                if (!checkbox) {
                    selectAllEl.innerHTML = '';

                    checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'mr-1';
                    checkbox.id = `${this.selectAllId}-checkbox`;

                    const label = document.createElement('span');
                    label.textContent = 'å…¨é€‰';

                    selectAllEl.appendChild(checkbox);
                    selectAllEl.appendChild(label);

                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        const optionCheckboxes = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]'))
                            .filter(cb => !cb.closest('#' + this.selectAllId));

                        if (e.target.checked) {
                            this.selectedValues = optionCheckboxes
                                .map(cb => cb.dataset.value)
                                .filter(Boolean);

                            optionCheckboxes.forEach(cb => cb.checked = true);
                        } else {
                            this.selectedValues = [];
                            optionCheckboxes.forEach(cb => cb.checked = false);
                        }

                        this.updateDisplay();
                        this.updateTags();

                        if (this.onChange) this.onChange([...this.selectedValues]);
                        this.openDropdown();
                    });
                }

                const isAllSelected = visibleOptionsCount > 0 && selectedCount === visibleOptionsCount;
                checkbox.checked = isAllSelected;
            }

            updateDisplay() {
                const displayEl = document.getElementById(this.displayId);
                if (!displayEl) return;
                if (this.selectedValues.length === 0) {
                    displayEl.textContent = 'è¯·é€‰æ‹©';
                } else if (this.selectedValues.length === 1) {
                    const selectedOption = this.allOptions.find(opt => opt.value === this.selectedValues[0]);
                    displayEl.textContent = selectedOption ? selectedOption.label : 'å·²é€‰æ‹©';
                } else if (this.selectedValues.length === this.allOptions.length) {
                    displayEl.textContent = 'å…¨éƒ¨å·²é€‰æ‹©';
                } else {
                    displayEl.textContent = `å·²é€‰æ‹© ${this.selectedValues.length} é¡¹`;
                }

                const hiddenInput = document.getElementById(this.valueId);
                if (hiddenInput) hiddenInput.value = JSON.stringify(this.selectedValues);
            }

            updateTags() {
                const tagsContainer = document.getElementById(this.tagsId);
                if (!tagsContainer) return;
                tagsContainer.innerHTML = '';

                if (this.selectedValues.length > 5) {
                    const tagEl = document.createElement('div');
                    tagEl.className = 'selected-tag';
                    tagEl.innerHTML = `å·²é€‰æ‹© ${this.selectedValues.length} é¡¹ <span class="tag-remove" data-clear="all">Ã—</span>`;

                    tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.clearSelection();
                    });

                    tagsContainer.appendChild(tagEl);
                    return;
                }

                this.selectedValues.forEach(value => {
                    const option = this.allOptions.find(opt => opt.value === value);
                    if (!option) return;

                    const tagEl = document.createElement('div');
                    tagEl.className = 'selected-tag';
                    tagEl.innerHTML = `
                        ${option.label}
                        <span class="tag-remove" data-value="${value}">Ã—</span>
                    `;

                    tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleSelection(e.target.dataset.value, false);
                    });

                    tagsContainer.appendChild(tagEl);
                });
            }

            clearSelection() {
                this.selectedValues = [];
                this.updateDisplay();
                this.updateTags();
                this.updateSelectAllStatus();
                const searchInput = document.getElementById(this.searchId);
                this.renderOptions(searchInput ? searchInput.value : '');
                if (this.onChange) this.onChange([]);
            }

            toggleDropdown() {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;
                optionsContainer.classList.toggle('hidden');
            }

            closeDropdown() {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;
                optionsContainer.classList.add('hidden');
            }

            openDropdown() {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;
                optionsContainer.classList.remove('hidden');
            }

            getSelectedValues() {
                return [...this.selectedValues];
            }
        }

        // ä¸‹è½½å·¥å…·å‡½æ•°ï¼ˆé€šç”¨ï¼‰
        function downloadFile(filename, content, mimeType = 'application/octet-stream') {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 500);
        }

        function chartToCSV(chart) {
            if (!chart) return '';
            const labels = chart.data.labels || [];
            const datasets = chart.data.datasets || [];

            const header = ['åˆ†ç»„', ...datasets.map(ds => ds.label || '')];
            const rows = [header];

            for (let i = 0; i < labels.length; i++) {
                const row = [labels[i]];
                for (let j = 0; j < datasets.length; j++) {
                    const value = datasets[j].data && typeof datasets[j].data[i] !== 'undefined'
                        ? datasets[j].data[i]
                        : '';
                    row.push(value);
                }
                rows.push(row);
            }

            const csvLines = rows.map(cols => cols.map(cell => {
                if (cell === null || typeof cell === 'undefined') return '';
                const cellStr = String(cell);
                if (/[",\n]/.test(cellStr)) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            }).join(','));

            return '\uFEFF' + csvLines.join('\n');
        }

        // ä¸»åº”ç”¨ç±»
        class TrendAnalysisApp {
            constructor() {
                this.cacheManager = cacheManager;
                this.cycleEngine = new CycleRuleEngine();
                this.chartGenerator = new ChartGenerator();

                this.initMultiSelects();

                this.data = null;
                this.filteredData = null;
                this.rawData = null;
                this.filterValues = {
                    'æµ‹ç«™åç§°': [],
                    'å®¢æˆ·åç§°': [],
                    'å«æ˜Ÿåç§°': [],
                    'ä»»åŠ¡ç»“æœçŠ¶æ€': [],
                    'ä»»åŠ¡ç±»å‹': []
                };

                this.init();
            }

            initMultiSelects() {
                this.stationSelect = new MultiSelectDropdown(
                    'stationDropdown', 'stationOptions', 'stationDisplay',
                    'stationValue', 'stationTags', 'stationSearch', 'selectAllStations',
                    (values) => this.updateSatelliteOptions()
                );

                this.customerSelect = new MultiSelectDropdown(
                    'customerDropdown', 'customerOptions', 'customerDisplay',
                    'customerValue', 'customerTags', 'customerSearch', 'selectAllCustomers',
                    (values) => this.updateSatelliteOptions()
                );

                this.satelliteSelect = new MultiSelectDropdown(
                    'satelliteDropdown', 'satelliteOptions', 'satelliteDisplay',
                    'satelliteValue', 'satelliteTags', 'satelliteSearch', 'selectAllSatellites',
                    (values) => this.updateStatusOptions()
                );

                this.statusSelect = new MultiSelectDropdown(
                    'statusDropdown', 'statusOptions', 'statusDisplay',
                    'statusValue', 'statusTags', 'statusSearch', 'selectAllStatuses',
                    (values) => this.updateTypeOptions()
                );

                this.typeSelect = new MultiSelectDropdown(
                    'typeDropdown', 'typeOptions', 'typeDisplay',
                    'typeValue', 'typeTags', 'typeSearch', 'selectAllTypes'
                );
            }

            async init() {
                this.setupEventListeners();
                await this.loadData();
                this.addDebugButtons();
                this.bindDownloadButtons();
            }

            setupEventListeners() {
                const applyBtn = document.getElementById('applyFilters');
                if (applyBtn) applyBtn.addEventListener('click', () => this.applyFilters());
                const resetBtn = document.getElementById('resetFilters');
                if (resetBtn) resetBtn.addEventListener('click', () => this.resetFilters());
                const configBtn = document.getElementById('configGroupingBtn');
                if (configBtn) configBtn.addEventListener('click', () => this.openCycleConfigModal());
                const closeModalBtn = document.getElementById('closeConfigModal');
                if (closeModalBtn) closeModalBtn.addEventListener('click', () => this.closeCycleConfigModal());
                const saveConfigBtn = document.getElementById('saveGroupingConfig');
                if (saveConfigBtn) saveConfigBtn.addEventListener('click', () => this.saveCycleConfig());
                
                // æ•°æ®æ ‡ç­¾æ˜¾ç¤ºåˆ‡æ¢äº‹ä»¶
                const showDataLabelsCheckbox = document.getElementById('showDataLabels');
                if (showDataLabelsCheckbox) {
                    showDataLabelsCheckbox.addEventListener('change', () => {
                        if (this.filteredData && this.filteredData.length > 0) {
                            const groupBy = document.getElementById('groupBy').value;
                            this.generateAllCharts(groupBy);
                        }
                    });
                }
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => {
                    document.getElementById('mobileMenu').classList.toggle('hidden');
                });

                const dayStartEl = document.getElementById('dayStart');
                if (dayStartEl) dayStartEl.addEventListener('change', (e) => {
                    document.getElementById('dayStartDisplay').textContent = e.target.value;
                    document.getElementById('dayEndDisplay').textContent = e.target.value;
                });
            }

            openCycleConfigModal() {
                const modal = document.getElementById('groupingConfigModal');
                const modalContent = document.getElementById('modalContent');

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);

                document.getElementById('dayStart').value = this.cycleEngine.config.day.start;
                document.getElementById('dayStartDisplay').textContent = this.cycleEngine.config.day.start;
                document.getElementById('dayEndDisplay').textContent = this.cycleEngine.config.day.start;

                document.getElementById('weekStartDay').value = this.cycleEngine.config.week.startDay;
                document.getElementById('weekStartTime').value = this.cycleEngine.config.week.startTime;

                document.getElementById('monthStartDate').value = this.cycleEngine.config.month.startDate;
                document.getElementById('monthStartTime').value = this.cycleEngine.config.month.startTime;

                document.getElementById('quarterStartMonth').value = this.cycleEngine.config.quarter.startMonth;
                document.getElementById('quarterStartTime').value = this.cycleEngine.config.quarter.startTime;
            }

            closeCycleConfigModal() {
                const modal = document.getElementById('groupingConfigModal');
                const modalContent = document.getElementById('modalContent');

                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');

                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            saveCycleConfig() {
                const newConfig = {
                    day: {
                        start: document.getElementById('dayStart').value
                    },
                    week: {
                        startDay: parseInt(document.getElementById('weekStartDay').value),
                        startTime: document.getElementById('weekStartTime').value
                    },
                    month: {
                        startDate: parseInt(document.getElementById('monthStartDate').value),
                        startTime: document.getElementById('monthStartTime').value
                    },
                    quarter: {
                        startMonth: parseInt(document.getElementById('quarterStartMonth').value),
                        startTime: document.getElementById('quarterStartTime').value
                    }
                };

                this.cycleEngine.updateConfig(newConfig);
                this.closeCycleConfigModal();

                if (this.filteredData) {
                    this.applyFilters();
                }
            }

            async loadData() {
                const dbLoading = document.getElementById('dbLoading');
                if (dbLoading) dbLoading.classList.remove('hidden');

                try {
                    // æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦å­˜åœ¨
                    const cacheExists = await this.cacheManager.checkAllDataCache();
                    
                    if (!cacheExists) {
                        if (dbLoading) dbLoading.classList.add('hidden');
                        document.getElementById('noDataAlert').classList.remove('hidden');
                        return;
                    }

                    console.log('ğŸ“ ä»æœ¬åœ°ç¼“å­˜åŠ è½½æ•°æ®...');

                    // ä»æœ¬åœ°ç¼“å­˜è·å–æ‰€æœ‰æ•°æ®
                    const records = await this.cacheManager.queryAllData();
                    
                    this.data = records || [];

                    console.log(`âœ… åŠ è½½äº† ${this.data.length} æ¡è®°å½•`);

                    this.extractFilterValues();
                    this.initializeFilters();

                    if (dbLoading) dbLoading.classList.add('hidden');
                    document.getElementById('filterSection').classList.remove('hidden');
                    document.getElementById('chartsSection').classList.remove('hidden');

                    this.updateDebugInfo();

                } catch (error) {
                    if (dbLoading) dbLoading.classList.add('hidden');
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    
                    // æ˜¾ç¤ºæ— æ•°æ®æç¤º
                    const noDataAlert = document.getElementById('noDataAlert');
                    if (noDataAlert) {
                        noDataAlert.classList.remove('hidden');
                    }
                }
            }

            extractFilterValues() {
                Object.keys(this.filterValues).forEach(key => this.filterValues[key] = []);

                if (!this.data || !this.data.length) return;

                this.data.forEach(item => {
                    Object.keys(this.filterValues).forEach(systemField => {
                        const dataField = FIELD_MAPPING[systemField];
                        if (!dataField) return;

                        const value = (item[dataField] || '').toString().trim();
                        if (value && !this.filterValues[systemField].includes(value)) {
                            this.filterValues[systemField].push(value);
                        }
                    });
                });

                Object.keys(this.filterValues).forEach(key => {
                    this.filterValues[key].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                });
            }

            initializeFilters() {
                const stationOptions = this.filterValues['æµ‹ç«™åç§°'].map(station => ({ value: station, label: station }));
                this.stationSelect.setOptions(stationOptions);

                const customerOptions = this.filterValues['å®¢æˆ·åç§°'].map(customer => ({ value: customer, label: customer }));
                this.customerSelect.setOptions(customerOptions);

                if (this.filterValues['å®¢æˆ·åç§°'].length === 0 && this.data.some(item => item[FIELD_MAPPING['å®¢æˆ·åç§°']])) {
                    document.getElementById('dataStructureAlert').classList.remove('hidden');
                    document.getElementById('structureMsg').textContent =
                        `å·²è‡ªåŠ¨æ˜ å°„å­—æ®µ: "${FIELD_MAPPING['å®¢æˆ·åç§°']}" â†’ "å®¢æˆ·åç§°"`;
                }
            }

            updateSatelliteOptions() {
                this.resetSubsequentFilters('satellite');

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();

                if (!stationValues.length && !customerValues.length) {
                    document.getElementById('satelliteDisplay').textContent = 'è¯·å…ˆé€‰æ‹©æµ‹ç«™æˆ–å®¢æˆ·';
                    return;
                }

                const filteredSatellites = [...new Set(
                    this.data
                        .filter(item => {
                            const matchesStation = !stationValues.length ||
                                                  stationValues.includes((item[FIELD_MAPPING['æµ‹ç«™åç§°']] || '').toString().trim());
                            const matchesCustomer = !customerValues.length ||
                                                  customerValues.includes((item[FIELD_MAPPING['å®¢æˆ·åç§°']] || '').toString().trim());
                            return matchesStation && matchesCustomer;
                        })
                        .map(item => (item[FIELD_MAPPING['å«æ˜Ÿåç§°']] || '').toString().trim())
                        .filter(Boolean)
                )].sort();

                const satelliteOptions = filteredSatellites.map(satellite => ({ value: satellite, label: satellite }));
                this.satelliteSelect.setOptions(satelliteOptions);
                document.getElementById('satelliteDisplay').textContent = 'è¯·é€‰æ‹©å«æ˜Ÿ';
            }

            updateStatusOptions() {
                this.resetSubsequentFilters('status');

                const satelliteValues = this.satelliteSelect.getSelectedValues();
                if (!satelliteValues.length) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();

                const filteredStatuses = [...new Set(
                    this.data
                        .filter(item => !stationValues.length || stationValues.includes((item[FIELD_MAPPING['æµ‹ç«™åç§°']] || '').toString().trim()))
                        .filter(item => !customerValues.length || customerValues.includes((item[FIELD_MAPPING['å®¢æˆ·åç§°']] || '').toString().trim()))
                        .filter(item => satelliteValues.includes((item[FIELD_MAPPING['å«æ˜Ÿåç§°']] || '').toString().trim()))
                        .map(item => (item[FIELD_MAPPING['ä»»åŠ¡ç»“æœçŠ¶æ€']] || '').toString().trim())
                        .filter(Boolean)
                )].sort();

                const statusOptions = filteredStatuses.map(status => ({ value: status, label: status }));
                this.statusSelect.setOptions(statusOptions);
                document.getElementById('statusDisplay').textContent = 'è¯·é€‰æ‹©ä»»åŠ¡çŠ¶æ€';
            }

            updateTypeOptions() {
                this.resetSubsequentFilters('type');

                const statusValues = this.statusSelect.getSelectedValues();
                if (!statusValues.length) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();

                const filteredTypes = [...new Set(
                    this.data
                        .filter(item => !stationValues.length || stationValues.includes((item[FIELD_MAPPING['æµ‹ç«™åç§°']] || '').toString().trim()))
                        .filter(item => !customerValues.length || customerValues.includes((item[FIELD_MAPPING['å®¢æˆ·åç§°']] || '').toString().trim()))
                        .filter(item => !satelliteValues.length || satelliteValues.includes((item[FIELD_MAPPING['å«æ˜Ÿåç§°']] || '').toString().trim()))
                        .filter(item => statusValues.includes((item[FIELD_MAPPING['ä»»åŠ¡ç»“æœçŠ¶æ€']] || '').toString().trim()))
                        .map(item => (item[FIELD_MAPPING['ä»»åŠ¡ç±»å‹']] || '').toString().trim())
                        .filter(Boolean)
                )].sort();

                const typeOptions = filteredTypes.map(type => ({ value: type, label: type }));
                this.typeSelect.setOptions(typeOptions);
                document.getElementById('typeDisplay').textContent = 'è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹';
            }

            resetSubsequentFilters(after = '') {
                const filterOrder = ['station', 'customer', 'satellite', 'status', 'type'];
                const startIndex = after ? filterOrder.indexOf(after) + 1 : 1;

                for (let i = startIndex; i < filterOrder.length; i++) {
                    const filterType = filterOrder[i];
                    const select = this[`${filterType}Select`];
                    if (select) select.clearSelection();
                }
            }

            // Helper: ä¸¥æ ¼æŒ‰ç…§åŒ—äº¬æ—¶é—´è§£æå„ç§æ—¶é—´å€¼
            parseToBeijingTime(value) {
                if (!value && value !== 0) return null;
                
                // å¦‚æœå·²ç»æ˜¯Dateå¯¹è±¡ï¼Œç¡®ä¿æŒ‰åŒ—äº¬æ—¶é—´å¤„ç†
                if (value instanceof Date) {
                    // åˆ›å»ºæ–°çš„Dateå¯¹è±¡ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
                    return new Date(
                        value.getFullYear(), value.getMonth(), value.getDate(),
                        value.getHours(), value.getMinutes(), value.getSeconds(), value.getMilliseconds()
                    );
                }

                // å¤„ç† Excel æ•°å­—åºåˆ—ï¼ˆå¦‚æœæœ‰ï¼‰
                if (typeof value === 'number') {
                    try {
                        // Excelåºåˆ—å·è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
                        const baseDate = new Date(1900, 0, 1); // ExcelåŸºå‡†æ—¥æœŸ
                        const days = Math.floor(value - 1); // Excelä»1å¼€å§‹è®¡æ•°
                        const hours = (value - Math.floor(value)) * 24;
                        const date = new Date(baseDate.getTime() + days * 24 * 60 * 60 * 1000);
                        date.setHours(Math.floor(hours), Math.floor((hours % 1) * 60), 0, 0);
                        return date;
                    } catch (e) {
                        return new Date(value);
                    }
                }

                if (typeof value === 'string') {
                    const s = value.trim();
                    
                    // ç§»é™¤æ—¶åŒºæ ‡è¯†ï¼Œå¼ºåˆ¶æŒ‰æœ¬åœ°æ—¶é—´(åŒ—äº¬æ—¶é—´)è§£æ
                    const cleanStr = s.replace(/[TZ]/g, ' ').replace(/[+-]\d{2}:\d{2}$/, '').trim();
                    
                    // æ ‡å‡†æ ¼å¼: YYYY-MM-DD æˆ– YYYY-MM-DD HH:MM:SS
                    const dateTimeMatch = cleanStr.match(/^(\d{4})-(\d{2})-(\d{2})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
                    if (dateTimeMatch) {
                        const y = parseInt(dateTimeMatch[1], 10);
                        const m = parseInt(dateTimeMatch[2], 10) - 1; // æœˆä»½ä»0å¼€å§‹
                        const d = parseInt(dateTimeMatch[3], 10);
                        const hh = parseInt(dateTimeMatch[4] || '0', 10);
                        const mm = parseInt(dateTimeMatch[5] || '0', 10);
                        const ss = parseInt(dateTimeMatch[6] || '0', 10);
                        
                        // ç›´æ¥åˆ›å»ºåŒ—äº¬æ—¶é—´çš„Dateå¯¹è±¡
                        return new Date(y, m, d, hh, mm, ss, 0);
                    }

                    // å…¶ä»–æ ¼å¼å°è¯•è§£æ
                    const fallback = new Date(cleanStr);
                    if (!isNaN(fallback.getTime())) {
                        // ç¡®ä¿æ˜¯æŒ‰åŒ—äº¬æ—¶é—´è§£é‡Šçš„
                        return new Date(
                            fallback.getFullYear(), fallback.getMonth(), fallback.getDate(),
                            fallback.getHours(), fallback.getMinutes(), fallback.getSeconds()
                        );
                    }

                    return null;
                }

                // fallback
                const fallback = new Date(value);
                return isNaN(fallback.getTime()) ? null : fallback;
            }

            // å°† start/end çš„ YYYY-MM-DD è¾“å…¥æ˜ å°„åˆ°åŸºäºå‘¨æœŸè§„åˆ™çš„å®é™…è¾¹ç•Œï¼ˆstart inclusive, end inclusiveï¼‰
            computeDateRangeForGroup(groupType, startDateStr, endDateStr) {
                let startBound = null;
                let endBound = null;

                const makeMidday = (dateStr) => {
                    if (!dateStr) return null;
                    const parts = dateStr.split('-').map(Number);
                    return new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0, 0);
                };

                try {
                    if (startDateStr) {
                        const midStart = makeMidday(startDateStr);
                        let gStart;
                        switch (groupType) {
                            case 'day':
                                gStart = this.cycleEngine.getDayGroup(midStart);
                                break;
                            case 'week':
                                gStart = this.cycleEngine.getWeekGroup(midStart);
                                break;
                            case 'month':
                                gStart = this.cycleEngine.getMonthGroup(midStart);
                                break;
                            case 'quarter':
                                gStart = this.cycleEngine.getQuarterGroup(midStart);
                                break;
                        }
                        if (gStart) startBound = gStart.rangeStart;
                    }

                    if (endDateStr) {
                        const midEnd = makeMidday(endDateStr);
                        let gEnd;
                        switch (groupType) {
                            case 'day':
                                gEnd = this.cycleEngine.getDayGroup(midEnd);
                                break;
                            case 'week':
                                gEnd = this.cycleEngine.getWeekGroup(midEnd);
                                break;
                            case 'month':
                                gEnd = this.cycleEngine.getMonthGroup(midEnd);
                                break;
                            case 'quarter':
                                gEnd = this.cycleEngine.getQuarterGroup(midEnd);
                                break;
                        }

                        if (gEnd) {
                            // inclusive end bound -> rangeEnd - 1ms
                            endBound = new Date(gEnd.rangeEnd.getTime() - 1);
                        }
                    }
                } catch (err) {
                    console.warn('computeDateRangeForGroup failed, fallback to Beijing time bounds', err);
                    if (startDateStr) startBound = this.parseToBeijingTime(`${startDateStr} 00:00:00`);
                    if (endDateStr) endBound = this.parseToBeijingTime(`${endDateStr} 23:59:59`);
                }

                return { startDate: startBound, endDate: endBound };
            }

            // åº”ç”¨ç­›é€‰ï¼ˆä¿®å¤æ—¶é—´è½´èŒƒå›´é—®é¢˜ï¼‰
            applyFilters() {
                if (!this.data) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();
                const statusValues = this.statusSelect.getSelectedValues();
                const typeValues = this.typeSelect.getSelectedValues();

                // å…ˆè®¡ç®—å‘¨æœŸæ€§èŒƒå›´è¾¹ç•Œï¼ˆå°† YYYY-MM-DD æ˜ å°„åˆ°å¯¹åº”å‘¨æœŸçš„ rangeStart/rangeEndï¼‰
                const groupBy = document.getElementById('groupBy').value;
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const range = this.computeDateRangeForGroup(groupBy, startInput, endInput);
                const startBound = range.startDate; // may be null
                const endBound = range.endDate; // may be null (inclusive)

                // ä¸¥æ ¼æŒ‰ç…§åŒ—äº¬æ—¶é—´å¤„ç†æ•°æ®ä¸­çš„å¼€å§‹æ—¶é—´å­—æ®µ
                const normalizedField = FIELD_MAPPING['å¼€å§‹æ—¶é—´'];
                const dataForFiltering = this.data.map(item => {
                    const newItem = Object.assign({}, item);
                    // ä½¿ç”¨åŒ—äº¬æ—¶é—´è§£æå‡½æ•°ç¡®ä¿æ—¶é—´å‡†ç¡®æ€§
                    newItem[normalizedField] = this.parseToBeijingTime(item[normalizedField]);
                    return newItem;
                });

                // è¿‡æ»¤ï¼ˆæ‰€æœ‰æ¡ä»¶ä¸º "ä¸”"ï¼‰
                this.filteredData = dataForFiltering.filter(item => {
                    const itemDate = item[normalizedField];
                    if (!itemDate) return false;

                    // æ—¶é—´èŒƒå›´æ¯”è¾ƒï¼ˆä½¿ç”¨æ–‡ä»¶æ—¶é—´è¯­ä¹‰ï¼‰
                    if (startBound && itemDate < startBound) return false;
                    if (endBound && itemDate > endBound) return false;

                    // æµ‹ç«™
                    if (stationValues.length && !stationValues.includes((item[FIELD_MAPPING['æµ‹ç«™åç§°']] || '').toString().trim())) {
                        return false;
                    }

                    // å®¢æˆ·
                    if (customerValues.length && !customerValues.includes((item[FIELD_MAPPING['å®¢æˆ·åç§°']] || '').toString().trim())) {
                        return false;
                    }

                    // å«æ˜Ÿ
                    if (satelliteValues.length && !satelliteValues.includes((item[FIELD_MAPPING['å«æ˜Ÿåç§°']] || '').toString().trim())) {
                        return false;
                    }

                    // çŠ¶æ€
                    if (statusValues.length && !statusValues.includes((item[FIELD_MAPPING['ä»»åŠ¡ç»“æœçŠ¶æ€']] || '').toString().trim())) {
                        return false;
                    }

                    // ç±»å‹
                    if (typeValues.length && !typeValues.includes((item[FIELD_MAPPING['ä»»åŠ¡ç±»å‹']] || '').toString().trim())) {
                        return false;
                    }

                    return true;
                });

                // ç”Ÿæˆå›¾è¡¨
                this.generateAllCharts(groupBy);
            }

            generateAllCharts(groupBy) {
                if (!this.filteredData || !this.filteredData.length) {
                    this.clearAllCharts();
                    return;
                }

                this.generateCategoryChart('stationChart', 'æµ‹ç«™åç§°è¶‹åŠ¿åˆ†æ', 'æµ‹ç«™åç§°', groupBy);
                this.generateCategoryChart('customerChart', 'å®¢æˆ·åç§°è¶‹åŠ¿åˆ†æ', 'å®¢æˆ·åç§°', groupBy);
                this.generateCategoryChart('satelliteChart', 'å«æ˜Ÿåç§°è¶‹åŠ¿åˆ†æ', 'å«æ˜Ÿåç§°', groupBy);
                this.generateCategoryChart('statusChart', 'ä»»åŠ¡ç»“æœçŠ¶æ€è¶‹åŠ¿åˆ†æ', 'ä»»åŠ¡ç»“æœçŠ¶æ€', groupBy);
                this.generateCategoryChart('typeChart', 'ä»»åŠ¡ç±»å‹è¶‹åŠ¿åˆ†æ', 'ä»»åŠ¡ç±»å‹', groupBy);
            }

            generateCategoryChart(chartId, title, categoryField, groupBy) {
                // ä½¿ç”¨å·²ç»æ ‡å‡†åŒ–ï¼ˆæœ¬åœ° Dateï¼‰çš„å­—æ®µè¿›è¡Œåˆ†ç»„ï¼šgroupByStartTime ä¼šç”¨ item[FIELD_MAPPING['å¼€å§‹æ—¶é—´']] çš„å€¼ï¼ˆç°åœ¨ä¸º Dateï¼‰
                const groupedResult = this.cycleEngine.groupByStartTime(
                    this.filteredData,
                    groupBy,
                    FIELD_MAPPING['è®¡åˆ’ID'],
                    FIELD_MAPPING['å¼€å§‹æ—¶é—´']
                );

                if (!groupedResult.sortedKeys.length) {
                    const emptyEl = document.getElementById(`${chartId}Empty`);
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    this.chartGenerator.destroyChart(chartId);
                    return;
                }

                const categories = [...new Set(
                    this.filteredData.map(item => {
                        const value = (item[FIELD_MAPPING[categoryField]] || '').toString().trim();
                        return value || 'æœªçŸ¥';
                    })
                )];

                const xLabels = groupedResult.sortedKeys.map(key =>
                    groupedResult.groupMetadata[key].label
                );

                const datasets = categories.map(category => ({
                    label: category,
                    data: groupedResult.sortedKeys.map(key =>
                        groupedResult.groups[key].filter(item => {
                            const value = (item[FIELD_MAPPING[categoryField]] || '').toString().trim();
                            const normalizedValue = value || 'æœªçŸ¥';
                            return normalizedValue === category;
                        }).length
                    )
                }));

                const chart = this.chartGenerator.generateTrendChart(chartId, title, xLabels, datasets);
                return chart;
            }

            resetFilters() {
                this.stationSelect.clearSelection();
                this.customerSelect.clearSelection();
                this.satelliteSelect.clearSelection();
                this.statusSelect.clearSelection();
                this.typeSelect.clearSelection();

                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';

                this.clearAllCharts();
            }

            clearAllCharts() {
                ['stationChart', 'customerChart', 'satelliteChart', 'statusChart', 'typeChart'].forEach(id => {
                    this.chartGenerator.destroyChart(id);
                    const emptyEl = document.getElementById(`${id}Empty`);
                    if (emptyEl) emptyEl.classList.remove('hidden');
                });
            }

            updateDebugInfo() {
                const debugContent = document.getElementById('debugContent');
                let info = "å­—æ®µæ˜ å°„é…ç½®:\n";
                Object.entries(FIELD_MAPPING).forEach(([sys, data]) => {
                    info += `  ç³»ç»Ÿå­—æ®µ"${sys}" â†’ æ•°æ®å­—æ®µ"${data}"\n`;
                });

                info += "\nç­›é€‰å­—æ®µæ•°æ®:\n";
                Object.entries(this.filterValues).forEach(([field, values]) => {
                    info += `  ${field}: ${values.length} é¡¹\n`;
                });

                debugContent.textContent = info;
            }

            addDebugButtons() {
                const debugInfo = document.getElementById('debugInfo');
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'absolute top-4 right-4 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded';
                toggleBtn.textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
                toggleBtn.addEventListener('click', () => {
                    debugInfo.classList.toggle('hidden');
                    toggleBtn.textContent = debugInfo.classList.contains('hidden') ? 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯' : 'éšè—è°ƒè¯•ä¿¡æ¯';
                });

                document.querySelector('main').style.position = 'relative';
                document.querySelector('main').appendChild(toggleBtn);
            }

            bindDownloadButtons() {
                document.addEventListener('click', (e) => {
                    const btn = e.target.closest && e.target.closest('.chart-download-btn');
                    if (!btn) return;

                    const chartId = btn.getAttribute('data-chart');
                    const type = btn.getAttribute('data-type');

                    const chart = this.chartGenerator.charts[chartId];
                    if (!chart) {
                        alert('å½“å‰å›¾è¡¨æ— æ•°æ®æˆ–å°šæœªç”Ÿæˆï¼Œè¯·å…ˆåº”ç”¨ç­›é€‰ç”Ÿæˆå›¾è¡¨åå†ä¸‹è½½ã€‚');
                        return;
                    }

                    if (type === 'image') {
                        try {
                            const imgUrl = chart.toBase64Image();
                            const a = document.createElement('a');
                            a.href = imgUrl;
                            const now = new Date();
                            const ts = now.toISOString().replace(/[:.]/g, '-');
                            a.download = `${chartId}-${ts}.png`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => document.body.removeChild(a), 300);
                        } catch (err) {
                            console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥', err);
                            alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ”¯æŒæˆ–æ•°æ®é‡æ˜¯å¦è¿‡å¤§ã€‚');
                        }
                    } else if (type === 'csv') {
                        try {
                            const csv = chartToCSV(chart);
                            const now = new Date();
                            const ts = now.toISOString().replace(/[:.]/g, '-');
                            downloadFile(`${chartId}-${ts}.csv`, csv, 'text/csv;charset=utf-8;');
                        } catch (err) {
                            console.error('å¯¼å‡º CSV å¤±è´¥', err);
                            alert('å¯¼å‡º CSV å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚');
                        }
                    }
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.trendApp = new TrendAnalysisApp();
        });
    </script>
</body>
</html>
